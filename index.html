<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Tim Particles</title>
  </head>

  <body>
    <div id="placeholder"></div>
    <script src="validator.min.js"></script>
    <script src="common.js"></script>
    <script src="wrappedgl.js"></script>
    <script src="utilities.js"></script>
    <script src="camera.js"></script>
    <script src="simulator.js"></script>
    <script src="renderer.js"></script>
    <script src="simulatorrenderer.js"></script>
    <script src="timparticles.js"></script>
    <script type="text/template" id="main">
    canvas start<br>
    <canvas id="canvas" width="512" height="512"></canvas>
    <br>
    canvas end
    </script>

    <script type="text/template" id="no-support">
    <div id="container">
    <div id="error"></div>
    </div>
    </script>


    <script>
    

function createSqrFieldParams(name,maxStrength, strengthAtOneUnit,
			      fieldSize)
{
    //formula is:
    // f(x) = k/(l+x^2)
    // s = maxStrength
    // u = strengthAtOneUnit
    //
    // f(0) = s
    // f(1) = u
    //
    // f(0) = k/l
    // f(1) = k/(l+1)
    // s = k/l
    // u = k/(l+1)
    // k = s*l
    // u = s*l/(l+1)
    // u*(l+1) = s*l
    // u*l+u = s*l
    // u*l = s*l -u
    // u*l - s*l = -u
    // l*(u - s) = -u
    // l = -u / (u - s)
    // l = u / (s - u)
    // k = s * l

    var l = strengthAtOneUnit / (maxStrength - strengthAtOneUnit);
    var k = l * maxStrength;

    return { name: name,
	     shaderProgram: 'sqrForceProgram',
	     u_l: l,
	     u_k: k,
	     size: fieldSize,
	     radiusCalc:

	     //forceCharge is the forceCharge of the particle in question
	     //returns the radius after which the force will always be
	     //less than min_force
	     function(forceCharge, min_force) 
	     {
		 var eff_min_force = Math.abs(min_force / forceCharge);

		 // f(x) = k/(l+x^2)
		 // f(x) * (l+x^2) = k
		 // l+x^2 = k / f(x)
		 // x^2 = k / f(x) - l
		 // x = sqrt(k / f(x) - l)
		 return Math.sqrt(k/eff_min_force - l);
	     }
	   };
}


WrappedGL.checkWebGLSupportWithExtensions(
    ['ANGLE_instanced_arrays','WEBGL_depth_texture', 'OES_texture_float', 'OES_texture_float_linear', 'OES_texture_half_float', 'OES_texture_half_float_linear'],
    function () { //we have webgl
	document.getElementById('placeholder').outerHTML = document.getElementById('main').innerHTML;

	    //this starts the process
	var timBox = new TimParticles();
	timBox.addField(createSqrFieldParams(
	    "electric",
	    4,1, [512,512]
	));
	timBox.addField(createSqrFieldParams(
	    "nuclear",
	    15,0.5, [512,512]
	));
	timBox.addParticleType({ name: "electron",
				 forceProps: [
				     { forceCharge : -1.0 },
				     { forceCharge : 1.0 }
				 ],
				 mass: 0.01,
				 size: 2,
				 color: [0.,0.,1.],
				 particleCount: 512
				 });

	timBox.addParticleType({ name: "proton",
				 forceProps: [
				     { forceCharge : 1.0 },
				     { forceCharge : 1.0 }
				 ],
				 mass: 1.0,
				 size: 10,
				 color: [1.,0.,0.],
				 particleCount: 512
			       });
	timBox.addParticleType({ name: "neutron",
				 forceProps: [
				     //note that a forceCharge of zero
				     //will prevent the particle from being
				     //considered for the field when calculating,
				     //thereby speeeding up the simulation
				     { forceCharge : 0.0 },
				     { forceCharge : 1.0 }
				 ],
				 mass: 1.0,
				 size: 10,
				 color: [0.,1,0.],
				 particleCount: 512
			       });

	timBox.setParameters
	( { 
	    areaSize: [512,512], //ratio of width/height should match ratio
	    //of width/height of fields
	    targetSimTimePerSecond: 30,
	    maxParticleSpeedAreaUnitPerSimTime: 1,
	    simFramesPerRenderFrame: 1,
	    minForce:  0.001, //in unit/simTime^2
	    maxSpeed: 1.0 //in unit/simTime
	    
	  }
	);
	
	timBox.randomizeParticles(0.1);

	timBox.start();

        }, function (hasWebGL, unsupportedExtensions) {
            document.getElementById('placeholder').outerHTML = document.getElementById('no-support').innerHTML;
            if (!hasWebGL) { //webgl not supported
                document.getElementById('error').textContent = 'Unfortunately, your browser does not support WebGL';
            } else {
                document.getElementById('error').textContent = 'Unfortunately, your browser does not support the ' + concatenateWords(unsupportedExtensions) + " WebGL extension" + (unsupportedExtensions.length > 1 ? 's.' : '.');
            }
        }
    );
  </script>

  </body>
</html>

